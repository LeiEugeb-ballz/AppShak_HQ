# Phase 4 - Integrity & Recursive Self-Observation

- Date: 2026-03-01
- Branch: `phase4/integrity-inspection-20260301`
- Baseline: `phase3-certified`

## Scope

Phase 4 adds deterministic, inspection-grade self-observation without changing substrate, supervisor, PM baseline, metric definitions, projection contract, or UI write capabilities.

New modules:

- `appshak_integrity/`
- `appshak_stability/`
- `appshak_inspection/`

## Integrity Metrics Definitions

Generated by `appshak_integrity.report.build_integrity_report()` and persisted under `appshak_state/integrity/<timestamp>/report.json`.

- `arbitration.arbitration_efficiency_score`:
  mean of approval rate and mean aggregate score over in-window arbitration outcomes.
- `arbitration.revisions_before_execute_distribution`:
  histogram from `revisions_before_execute` (default `0` if absent).
- `arbitration.mean_decision_score_delta_per_revision`:
  mean of `(aggregate_score - previous_aggregate_score)` per arbitration entry.
- `arbitration.resolution_time`:
  unit = `event_steps` (deterministic fallback when wall-clock linkage not available).
- `trust.trust_volatility_score`:
  mean absolute `reputation_delta` over trust-change entries.
- `trust.governance_drift_indicator`:
  sum of trust `reputation_delta` in window (measurement only).
- `trust.trend.rolling_slope`:
  fixed-window linear slope over global trust variance values.
- `trust.trend.rolling_variance`:
  fixed-window variance over global trust variance values.
- `trust.trend.anomaly_flags`:
  fixed bands:
  - `slope_band_exceeded`: `abs(slope) > 0.05`
  - `variance_band_exceeded`: `variance > 0.02`

## Knowledge Propagation Velocity

Primary mode (`explicit_lessons`):

- source: `WATER_COOLER_LESSON` entries with `lesson.lesson_id`
- reuse detection: exact `lesson_id` match in later governance entry payloads
- `time_to_reuse`:
  unit = `event_steps`, computed as first matching future `seq - source_seq`
- `cross_agent_reuse_count`:
  consumers excluding source agent
- `propagation_depth`:
  distinct consumers per lesson (mean)
- `knowledge_propagation_velocity`:
  `1 / mean_time_to_reuse` when mean > 0, else `0`

Fallback mode (`signature_fallback`) if explicit lessons absent:

- signature rule: `(source_event_type, source_event_id, source_agent)` (documented in report output)

## Arbitration Efficiency Metrics

Ledger-derived metrics:

- revisions distribution
- decision score delta per revision
- resolution time in event-steps (explicitly labeled)

## Trust Trend Metrics

Uses trust-change and trust-stability ledger outputs:

- rolling slope
- rolling variance
- fixed-band anomaly flags

## Determinism Rules + Hashing

- Stable JSON serialization:
  - `json.dumps(..., ensure_ascii=True, sort_keys=True, separators=(",", ":"))`
- Hash algorithm:
  - SHA-256 over canonical JSON
- No randomness.
- Deterministic ordering:
  - primary: `event_id` when present
  - fallback: `(timestamp, stable payload hash)`

## Stability Harness Run Modes

Implemented in `appshak_stability.run`:

- `--duration-hours 6`
- `--duration-hours 12`
- `--duration-hours 24`

Checkpoint schema (`appshak_state/stability/<run_id>/checkpoints/checkpoint_XXXX.json`):

- `run_id`
- `checkpoint_id`
- `cycle`
- `timestamp`
- `projection_timestamp`
- `inspection_timestamp`
- `integrity_timestamp`
- `governance_replay_hash_checkpoint`
- `ledger_reconstruction_hash_checkpoint`
- `integrity_report_hash`
- `watchdog.status`
- `watchdog.reason`

Watchdog behavior:

- detect incident
- log incident in checkpoint + run meta
- halt runner cleanly
- no auto-repair/restart

## Inspection API Contracts

From `appshak_observability.server`:

- `GET /api/snapshot` (unchanged)
- `GET /api/inspect/entities`
- `GET /api/inspect/entity/{entity_id}`
- `GET /api/inspect/entity/{entity_id}/timeline?limit=...&cursor=...`
- `GET /api/inspect/office/timeline?limit=...&cursor=...`
- `GET /api/integrity/latest`
- `GET /api/integrity/history?limit=...&cursor=...`
- `GET /api/stability/runs`
- `GET /api/stability/run/{run_id}`
- `GET /api/health`

Websocket channels:

- `view_update`
- `inspect_update`
- `integrity_update`

## UI Inspection Flows

Office View now includes:

- clickable entity list (agents/areas from inspection index)
- entity side panel:
  - id/role/state/presence
  - age
  - busy-with
  - restart/missed-heartbeat counts
  - trust snapshot + recent governance traces
- entity timeline with cursor pagination
- office timeline with cursor pagination
- integrity panel:
  - latest integrity summary
  - trust trend indicators
  - propagation summary
  - arbitration efficiency summary
  - stability run status + last checkpoint

All read-only.

## Always-On Runbook

Run all services, then inspect while tests are executing:

```bash
# 1) Swarm
python -m appshak_substrate.run_swarm --agents recon forge command --durable --worktrees --duration-seconds 1200

# 2) Projection
python -m appshak_projection.run_projector --mailstore-db appshak_state/substrate/mailstore.db --view-path appshak_state/projection/view.json --poll-interval 1

# 3) Integrity report
python -m appshak_integrity.run_report --window 7d

# 4) Inspection index
python -m appshak_inspection.run_index

# 5) Observability backend
python -m appshak_observability.server --host 127.0.0.1 --port 8010 --projection-view appshak_state/projection/view.json

# 6) UI
cd appshak-ui
npm install
npm run dev

# 7) Stability run
python -m appshak_stability.run --duration-hours 6

# 8) Tests while dashboard remains open
python -m unittest discover -s tests -p "test_*.py" -v
```

Ports:

- Observability backend: `127.0.0.1:8010`
- UI dev server: `localhost:5173`

## Data Integrity Policy (Applied)

Canonical append-only artifacts (never rewritten):

- governance ledger
- event history/audit logs

Derived artifacts (safe replace pointer + versioned outputs):

- integrity reports
- inspection indexes
- stability checkpoints

Write strategy:

- write new versioned file first
- atomically replace pointer file (`latest.json`, `index.json`, `run_meta.json`)
- no in-place JSON mutation
